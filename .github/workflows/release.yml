name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'CLI Buddy ${{ github.ref_name }}'
          releaseBody: |
            ## CLI Buddy ${{ github.ref_name }}

            ### Download
            - **`CLI.Buddy.exe`** — 포터블 (설치 없이 바로 실행)
            - **`CLI.Buddy_x64-setup.exe`** — 설치형 (자동시작, 시작메뉴 등록)
          releaseDraft: false
          prerelease: false

      - name: Find and upload portable exe
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.ref_name }}"
          $releaseDir = "src-tauri/target/release"

          Write-Host "=== Listing release directory ==="
          Get-ChildItem -Path $releaseDir -Filter "*.exe" | ForEach-Object {
            Write-Host "  $($_.Name) ($([math]::Round($_.Length / 1MB, 1)) MB)"
          }

          # Find the app exe (not setup, not uninstall)
          $candidates = Get-ChildItem -Path $releaseDir -Filter "*.exe" |
            Where-Object { $_.Name -notmatch "setup|uninstall|WixTools" -and $_.Length -gt 1MB }

          if ($candidates.Count -gt 0) {
            $exe = $candidates[0]
            Write-Host "Found portable exe: $($exe.FullName)"
            Copy-Item $exe.FullName -Destination "CLI.Buddy.exe"
            gh release upload $tag "CLI.Buddy.exe" --clobber
            Write-Host "Uploaded CLI.Buddy.exe"
          } else {
            Write-Host "ERROR: No portable exe found!"
            exit 1
          }
